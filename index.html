<html>
	<head>
		<meta charset="utf-8" />
		<title> Labyrint</title>
		<link rel="stylesheet" type="text/css" href="style.css">

		<script src="js/visualizer.js" type="text/javascript"></script>
		<script src="js/two.min.js"></script>
		<script src="js/pitch.js"></script>
		<script src="js/jquery.js"></script>

	</head>
	
	<body>
		<header>
			<link href='http://fonts.googleapis.com/css?family=Lobster' rel='stylesheet' type='text/css'>


			<div class="wrapper">
				<div class="game">
					<h1>Labyrint</h1>
					<span id="pitch">--</span>Hz</div>

				</div>	
				<canvas class="visualizer"></canvas>
			</div>

		</header>			


		<script>

		var gameDirection = 1;

		$(function() {
          btn_group.fill = changeGameDirection();

          // Update the renderer in order to generate corresponding DOM Elements.
          two.update();

          $(btn_group._renderer.elem)
            .css('cursor', 'pointer')
            .click(function(e) {
              btn_group.fill = changeGameDirection();
            });

          function changeGameDirection() {
          	if (gameDirection == 1){
            	gameDirection = 2;
            }
            else if (gameDirection == 2){
            	gameDirection = 1;
            }
          	
            return 'rgb('
              + Math.floor(Math.random() * 255) + ','
              + Math.floor(Math.random() * 255) + ','
              + Math.floor(Math.random() * 255) + ')';
			}

        });



          

			window.navigator = window.navigator || {};

     		navigator.getUserMedia = navigator.getUserMedia       ||
                               navigator.webkitGetUserMedia ||
                               navigator.mozGetUserMedia    ||
                               null;


            //Initierar ljudkontexten tillsammans med egenskaperna för analysen
			var context = new (window.AudioContext || window.webkitAudioContext)();
			var analyser = context.createAnalyser();
			analyser.fftSize = 2048;
			var bufferLength = analyser.frequencyBinCount; // half the FFT value
			bufferLength = bufferLength/15;
				var freqDomain = new Uint8Array(bufferLength); // create an array to store the data
			
			//Tar in mikrofonljud, samt ritar om intagandet går bra.
			navigator.getUserMedia({audio: true}, function(stream) {
				
				var source = context.createMediaStreamSource(stream);
				
				source.connect(analyser);
				
				//Updatera nuvarande pitch
				updatePitch();

				draw();

			}, errorCallback);

			//Om det inte går att få mikrofonljudet
			function errorCallback() {
    			
    			alert('something went wrong');
			}

			//Räknar ut pitch och uppdaterar siffran i dokumentet
			//TODO: Sammanfoga med existerande variabler
			var rafID = null;
			var buflen = 2048;
			var buf = new Uint8Array( buflen );
			var pitchElem = document.getElementById( "pitch" );

			//Initerar canvas-egenskaper
			var canvas = document.querySelector('.visualizer');
			var canvasCtx = canvas.getContext("2d");
			var intendedWidth = document.querySelector('.wrapper').clientWidth;
			canvas.setAttribute('width',intendedWidth);
			WIDTH = canvas.width;
			HEIGHT = canvas.height;
			canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);

			//..........All Graphics.......................
			// Make an instance of two and place it on the page
			var gamebox = document.querySelector('.game');
			var gamebox_height = document.querySelector('.game').clientHeight;


			var params = { width: intendedWidth, height: gamebox_height };
			var two = new Two(params).appendTo(gamebox);

			//HÅLET
			var hole_radius = 40;
			var hole = two.makeCircle(72, 100, hole_radius);
			hole.fill = 'grey';
			hole.stroke = 'black';
			hole.linewidth = 1;
			var hole_xPosition = intendedWidth - intendedWidth*0.1;
			var hole_yPosition = gamebox_height*0.08;
			hole.translation.set(hole_xPosition,hole_yPosition);	


			//BOLLEN
			var circle_radius = 20;
			var circle = two.makeCircle(72, 100, circle_radius);
			circle.fill = 'yellow';
			circle.stroke = 'red';
			circle.linewidth = 1;
			var xPosition = intendedWidth/2;
			var yPosition = gamebox_height - gamebox_height*0.3;
			circle.translation.set(xPosition,yPosition);

			// //BTN_GROUP
			// var horizontal = two.makeLine(10, 50, 110, 50);
			// horizontal.fill = 'yellow';
			// 			horizontal.stroke = 'red';

			// var vertical = two.makeLine(60, 0, 60, 100);

			// var btn_group = two.makeGroup(horizontal, vertical);
			// btn_group.linewidth = 4;

			//HDASDH

			var right = two.makePolygon(115, 100, 115, 150, 155, 125);
			var left = two.makePolygon(5, 125, 45, 150, 45, 100);
			var down = two.makePolygon(55, 165, 80, 205, 105, 165);
			var up = two.makePolygon(55, 85, 80, 45, 105, 85);
			var buttonCircle = two.makeCircle(80, 125, 100);
		
			var btn_horizontal = new Two.Group();
			var btn_vertical = new Two.Group();
			var btn_group = new Two.Group();

			btn_horizontal.add(right);
			btn_horizontal.add(left);
			btn_vertical.add(down);
			btn_vertical.add(up);

			buttonCircle.opacity = 0.1;

			btn_group.add(buttonCircle);
			btn_group.add(btn_vertical);
			btn_group.add(btn_horizontal);

			btn_group.scale = 0.5;
			btn_group.linewidth = 0;
			btn_group.translation.set(20, 0);

			two.add(btn_group);


			var delta = new Two.Vector(0, 0);
			
			var index = [0, 0, 0, 0, 0, 0, 0, 0];
			var j = 1;

			var maxValue;

			var circle_left = xPosition-circle_radius; 
			var circle_right = xPosition+circle_radius;
			var circle_top = yPosition+circle_radius;
			var circle_bottom = yPosition-circle_radius;

			var lowStreak=1;
			var highStreak=1;
			var lastPitch;

			var hole_left = hole_xPosition-hole_radius; 
			var hole_right = hole_xPosition+hole_radius;
			var hole_top = hole_yPosition+hole_radius;
			var hole_bottom = hole_yPosition-hole_radius;

			// animationloop
			two.bind('update', function(frameCount) {

				//Low tone if pitch is under 180
				if(pitch < 220){
					//Reset high tone in a row counter
					highStreak=1;

					if (pitch < lastPitch && lowStreak < 1000){
						lowStreak++;
					}

					//stops the ball from rollin' out of the window
					if ((xPosition + lowStreak * -1) > 20){
						delta.x = lowStreak * -1;
						xPosition = xPosition + lowStreak * -1;
						circle_left--;
						circle_right--;
					}
					else{
						delta.x = 0;
					}

					lastPitch=pitch;
				}

				//High tone if pitch is over 180 and not valid if over 1500
				else if(pitch >= 220 && pitch < 1500){
					//Reset low tone in a row counter
					lowStreak=1;

					if (pitch > lastPitch && highStreak < 1000){
						highStreak++;
					}

					//stops the ball from rollin' out of the window
					if ((xPosition + highStreak) < (intendedWidth-20)){
						delta.x = highStreak * 1; 
						xPosition = xPosition + highStreak * 1;
						circle_left++;
						circle_right++;
					}
					else{
						delta.x = 0;
					}

					lastPitch=pitch;
				}

				else
					delta.x = 0;

				if(circle_left > hole_left && circle_right < hole_right && circle_bottom> hole_bottom && circle_top < hole_top);
					//console.log("bärs");

				circle.translation.addSelf(delta);

			}).play();


			// render everything to the screen
			two.update();
			//..............................................

			function draw() {

				requestAnimationFrame(draw);

				analyser.getByteFrequencyData(freqDomain);

				setUpVisualizer();

				console.log (gameDirection);

			}

			function AllTheSame(array) {
				var first = array[0];
					return array.every(function(element) {
    				return element === first;
				});
			}

		</script>
	</body>
</html>