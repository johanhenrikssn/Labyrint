<html>
	<head>
		<meta charset="utf-8" />
		<title> Labyrint</title>
		<link rel="stylesheet" type="text/css" href="style.css">

		<script src="visualizer.js" type="text/javascript"></script>
		<script src="js/two.min.js"></script>
		<script src="js/tween.min.js"></script>
		<script src="js/pitch.js"></script>
	</head>
	
	<body>
			<header>
				<link href='http://fonts.googleapis.com/css?family=Lobster' rel='stylesheet' type='text/css'>


				<div class="wrapper">
					<div class="game">
						<h1>Labyrint</h1>
						<span id="pitch">--</span>Hz</div>

					</div>	
					<canvas class="visualizer"></canvas>
				</div>

			</header>			


			<script>

				window.navigator = window.navigator || {};

	     		navigator.getUserMedia = navigator.getUserMedia       ||
	                               navigator.webkitGetUserMedia ||
	                               navigator.mozGetUserMedia    ||
	                               null;


	            //Initierar ljudkontexten tillsammans med egenskaperna för analysen
				var context = new (window.AudioContext || window.webkitAudioContext)();
				var analyser = context.createAnalyser();
				analyser.fftSize = 2048;
				var bufferLength = analyser.frequencyBinCount; // half the FFT value
				bufferLength = bufferLength/15;
   				var freqDomain = new Uint8Array(bufferLength); // create an array to store the data
				
				//Tar in mikrofonljud, samt ritar om intagandet går bra.
				navigator.getUserMedia({audio: true}, function(stream) {
					
					var source = context.createMediaStreamSource(stream);
					
					source.connect(analyser);
					
					//Updatera nuvarande pitch
					updatePitch();

					draw();

				}, errorCallback);

				//Om det inte går att få mikrofonljudet
				function errorCallback() {
	    			
	    			alert('something went wrong');
				}

				//Räknar ut pitch och uppdaterar siffran i dokumentet
				//TODO: Sammanfoga med existerande variabler
				var rafID = null;
				var buflen = 2048;
				var buf = new Uint8Array( buflen );
				var pitchElem = document.getElementById( "pitch" );

				//Initerar canvas-egenskaper
				var canvas = document.querySelector('.visualizer');
				var canvasCtx = canvas.getContext("2d");
				var intendedWidth = document.querySelector('.wrapper').clientWidth;
				canvas.setAttribute('width',intendedWidth);
				WIDTH = canvas.width;
				HEIGHT = canvas.height;
				canvasCtx.clearRect(0, 0, WIDTH, HEIGHT);

				//..........All Graphics.......................
				// Make an instance of two and place it on the page
				var gamebox = document.querySelector('.game');
				var gamebox_height = document.querySelector('.game').clientHeight;


				var params = { width: intendedWidth, height: gamebox_height };
				var two = new Two(params).appendTo(gamebox);


				var circle = two.makeCircle(72, 100, 20);

				circle.fill = 'red';
				circle.stroke = 'yellow';
				circle.linewidth = 1;
				
				var xstartPosition = intendedWidth/2;
				var ystartPosition = gamebox_height - gamebox_height*0.2;
				circle.translation.set(xstartPosition,ystartPosition);

				var delta = new Two.Vector(0, 0);
				

				var index1 = 0;
				var index2 = 0;

				var maxValue;


			
				// animationloop
				two.bind('update', function(frameCount) {


					maxValue = Math.max.apply(Math, freqDomain);
					
					for(i = 0; i < freqDomain.length; i++)
					{
						if(freqDomain[i] == maxValue)
						{
							index2 = i;
							break;
						}
					}

					//det här under ska ändras
					if(index1 < index2)
						delta.x = -1;
					else if(index1 > index2)
						delta.x = 1;
				
					index1 = index2; 

					circle.translation.addSelf(delta);

				}).play();


				// render everything to the screen
				two.update();
				//..............................................


				

				function draw() {

					requestAnimationFrame(draw);

					analyser.getByteFrequencyData(freqDomain);

					setUpVisualizer();

				}

			

			</script>

	</body>
</html>